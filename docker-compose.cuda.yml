# =============================================================================
# Docker Compose override for CUDA support
# Usage: docker compose -f docker-compose.yml -f docker-compose.cuda.yml up -d
# Or: make docker-up-cuda
#
# Vector Database Storage:
#   Indices are persisted at ${NEXT_PLAID_DATA:-~/.local/share/next-plaid}
#
# Model Cache:
#   Downloaded HuggingFace models are cached at ${NEXT_PLAID_MODELS:-~/.cache/huggingface/next-plaid}
#
# CUDA Defaults (optimized for GPU):
#   --model lightonai/GTE-ModernColBERT-v1-onnx --cuda --batch-size 64
#   (no --int8: GPU is fast enough with FP32, no --parallel: GPU handles parallelism)
#
# Override with docker-compose.override.yml or run directly:
#   docker run -p 8080:8080 --gpus all -v ~/.local/share/next-plaid:/data/indices \
#     next-plaid-api:cuda --model my-org/my-model --cuda --batch-size 128
# =============================================================================

services:
  next-plaid-api:
    build:
      context: .
      dockerfile: next-plaid-api/Dockerfile
      target: runtime-cuda
    volumes:
      # Persistent vector database storage (default: ~/.local/share/next-plaid)
      - ${NEXT_PLAID_DATA:-~/.local/share/next-plaid}:/data/indices
      # Persistent model cache (auto-downloaded from HuggingFace)
      - ${NEXT_PLAID_MODELS:-~/.cache/huggingface/next-plaid}:/models
    environment:
      - RUST_LOG=info
      - NVIDIA_VISIBLE_DEVICES=all
    # CUDA defaults: FP32 model (GPU is fast), large batches, single session
    command:
      - --host
      - "0.0.0.0"
      - --port
      - "8080"
      - --index-dir
      - /data/indices
      - --model
      - lightonai/GTE-ModernColBERT-v1-onnx
      - --cuda
      - --batch-size
      - "64"
      - --query-length
      - "48"
      - --document-length
      - "300"
    healthcheck:
      start_period: 120s  # Longer start period for model download + CUDA initialization
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
