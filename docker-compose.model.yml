# =============================================================================
# Docker Compose override for model support (CPU encoding)
# Usage: docker compose -f docker-compose.yml -f docker-compose.model.yml up -d
# Or: make docker-up-model
# =============================================================================

services:
  lategrep-api:
    build:
      context: .
      dockerfile: api/Dockerfile
      target: runtime-model
    volumes:
      - lategrep-indices:/data/indices
      - lategrep-models:/models
    environment:
      # Auto-download model from HuggingFace Hub if not present
      - HF_MODEL_ID=lightonai/GTE-ModernColBERT-v1-onnx
      # Use INT8 quantized model for better performance
      - MODEL_QUANTIZED=true
    command: ["--host", "0.0.0.0", "--port", "8080", "--index-dir", "/data/indices", "--model", "/models/GTE-ModernColBERT-v1-onnx"]
    healthcheck:
      start_period: 120s  # Longer start period for model download + loading
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G

volumes:
  lategrep-models:
